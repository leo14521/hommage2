"use client";

import Link from "next/link";
import { useState } from "react";
import { useGSAP } from "@gsap/react";
import { gsap } from "gsap";
import { ScrollTrigger } from "gsap/ScrollTrigger";

gsap.registerPlugin(ScrollTrigger);

const TEL = "02-543-4842";

/** 예약·상담 (핵심 3개) */
const CONSULT_LINKS = [
  { icon: "fa-solid fa-phone", label: "전화", href: `tel:${TEL.replace(/-/g, "")}`, type: "tel" as const },
  { icon: "fa-solid fa-comment", label: "카톡상담", href: "#", color: "#FEE500" },
  { icon: "fa-solid fa-calendar-check", label: "네이버예약", href: "#", color: "#03C75A", highlight: true },
];

/** SNS (2개로 정리) */
const SNS_LINKS = [
  { icon: "fa-brands fa-instagram", label: "인스타그램", href: "#", color: "#E4405F" },
  { icon: "fa-brands fa-youtube", label: "유튜브", href: "#", color: "#FF0000" },
];

/**
 * 통합 플로팅: 예약·상담 + SNS 그룹화, TOP 버튼
 * - 모바일: 하단 하나의 바 (그룹 구분)
 * - PC: 우측 하나의 플로팅 패널 (접었다 펼치기)
 */
export default function FloatingBanner() {
  const [isExpanded, setIsExpanded] = useState(false);
  const [scrollVisible, setScrollVisible] = useState(false);
  const [callPopOpen, setCallPopOpen] = useState(false);

  useGSAP(
    () => {
      ScrollTrigger.create({
        trigger: "main",
        start: "top top-=15%",
        endTrigger: "footer",
        end: "top bottom",
        onEnter: () => setScrollVisible(true),
        onLeaveBack: () => setScrollVisible(false),
      });
    },
    { dependencies: [] }
  );

  const scrollToTop = () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  return (
    <>
      {/* 모바일: 하단 고정 바 — 예약·상담 | SNS | TOP 그룹화 */}
      <div className="fixed bottom-0 left-0 right-0 z-[1997] lg:hidden safe-area-inset-bottom">
        <div className="bg-white/95 backdrop-blur-md border-t border-black/10 shadow-[0_-4px_20px_rgba(0,0,0,0.08)]">
          <div className="flex items-stretch">
            {/* 예약·상담 그룹 */}
            <div className="flex flex-1 items-center justify-around border-r border-black/5 py-3">
              {CONSULT_LINKS.map((link, idx) =>
                link.type === "tel" ? (
                  <button
                    key={idx}
                    type="button"
                    onClick={() => setCallPopOpen(true)}
                    className="flex flex-col items-center gap-1 p-2 rounded-lg transition-all active:scale-95"
                    aria-label={link.label}
                  >
                    <div className="w-9 h-9 rounded-full flex items-center justify-center text-white bg-[#1a1918]">
                      <i className={`fa-solid ${link.icon} text-sm`} />
                    </div>
                    <span className="text-[10px] text-[#333] font-medium">{link.label}</span>
                  </button>
                ) : (
                  <Link
                    key={idx}
                    href={link.href}
                    className="flex flex-col items-center gap-1 p-2 rounded-lg transition-all active:scale-95"
                    aria-label={link.label}
                  >
                    <div
                      className={`w-9 h-9 rounded-full flex items-center justify-center text-white ${link.highlight ? "ring-2 ring-[#03C75A]/50" : ""}`}
                      style={{ backgroundColor: link.color || "#333" }}
                    >
                      <i className={`fa-solid ${link.icon} text-sm`} />
                    </div>
                    <span className="text-[10px] text-[#333] font-medium text-center leading-tight">{link.label}</span>
                  </Link>
                )
              )}
            </div>
            {/* SNS 그룹 */}
            <div className="flex items-center gap-1 px-2 py-3 border-r border-black/5">
              {SNS_LINKS.map((link, idx) => (
                <Link
                  key={idx}
                  href={link.href}
                  className="flex flex-col items-center gap-0.5 p-2 rounded-lg transition-all active:scale-95"
                  aria-label={link.label}
                >
                  <div className="w-8 h-8 rounded-full flex items-center justify-center text-white" style={{ backgroundColor: link.color || "#333" }}>
                    <i className={`${link.icon} text-xs`} />
                  </div>
                  <span className="text-[8px] text-[#666]">{link.label}</span>
                </Link>
              ))}
            </div>
            {/* TOP */}
            <div className="flex items-center px-3 py-3">
              <button
                type="button"
                onClick={scrollToTop}
                className="flex flex-col items-center justify-center gap-0.5 w-12 h-14 rounded-xl bg-[#1a1918] text-white transition-all active:scale-95"
                aria-label="맨 위로"
              >
                <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 19V5M5 12l7-7 7 7" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                <span className="text-[8px] font-medium">TOP</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* PC: 우측 하나의 플로팅 패널 — 예약·상담 + SNS + TOP */}
      <div
        className={`hidden lg:block fixed right-0 top-1/2 z-[1996] -translate-y-1/2 transition-all duration-300 ${
          scrollVisible ? "opacity-100 translate-x-0" : "opacity-0 translate-x-full pointer-events-none"
        }`}
      >
        <div className="relative flex items-center">
          {/* 토글 버튼 */}
          <button
            onClick={() => setIsExpanded(!isExpanded)}
            className="flex-shrink-0 w-11 h-14 bg-white/95 backdrop-blur-md rounded-l-xl shadow-lg border border-r-0 border-black/10 flex items-center justify-center text-[#333] hover:bg-white transition-all hover:scale-105"
            aria-label={isExpanded ? "퀵 메뉴 닫기" : "퀵 메뉴 열기"}
            aria-expanded={isExpanded}
          >
            <i className={`fa-solid text-sm transition-transform duration-300 ${isExpanded ? "fa-chevron-right" : "fa-chevron-left"}`} />
          </button>

          {/* 패널: 예약·상담 / SNS / TOP */}
          <div
            className={`bg-white/95 backdrop-blur-md border-l border-black/10 shadow-xl transition-all duration-300 overflow-hidden ${isExpanded ? "w-[180px]" : "w-0"}`}
          >
            <div className="py-4 px-3 w-[180px]">
              <p className="text-[10px] tracking-widest text-[#999] uppercase mb-2">예약·상담</p>
              <div className="flex flex-col gap-1.5 mb-4">
                {CONSULT_LINKS.map((link, idx) =>
                  link.type === "tel" ? (
                    <button
                      key={idx}
                      type="button"
                      onClick={() => setCallPopOpen(true)}
                      className="flex items-center gap-2.5 w-full rounded-lg py-2.5 px-3 text-left text-sm text-[#333] hover:bg-black/5 transition-colors"
                    >
                      <div className="w-8 h-8 rounded-full bg-[#1a1918] flex items-center justify-center text-white flex-shrink-0">
                        <i className={`fa-solid ${link.icon} text-xs`} />
                      </div>
                      <span>{link.label}</span>
                    </button>
                  ) : (
                    <Link
                      key={idx}
                      href={link.href}
                      className={`flex items-center gap-2.5 w-full rounded-lg py-2.5 px-3 text-sm text-[#333] hover:bg-black/5 transition-colors ${link.highlight ? "font-medium" : ""}`}
                    >
                      <div
                        className="w-8 h-8 rounded-full flex items-center justify-center text-white flex-shrink-0"
                        style={{ backgroundColor: link.color || "#333" }}
                      >
                        <i className={`fa-solid ${link.icon} text-xs`} />
                      </div>
                      <span>{link.label}</span>
                    </Link>
                  )
                )}
              </div>
              <p className="text-[10px] tracking-widest text-[#999] uppercase mb-2">SNS</p>
              <div className="flex gap-2 mb-4">
                {SNS_LINKS.map((link, idx) => (
                  <Link
                    key={idx}
                    href={link.href}
                    className="flex items-center justify-center w-9 h-9 rounded-full text-white transition-transform hover:scale-110"
                    style={{ backgroundColor: link.color || "#333" }}
                    aria-label={link.label}
                  >
                    <i className={`${link.icon} text-sm`} />
                  </Link>
                ))}
              </div>
              <button
                type="button"
                onClick={scrollToTop}
                className="flex items-center justify-center gap-1.5 w-full py-2.5 rounded-lg bg-[#1a1918] text-white text-sm font-medium hover:bg-[#2a2928] transition-colors"
                aria-label="맨 위로"
              >
                <svg className="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 19V5M5 12l7-7 7 7" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                TOP
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* 전화 문의 팝업 (모바일/PC 공통) */}
      <div
        className={`fixed left-1/2 top-1/2 z-[10000] -translate-x-1/2 -translate-y-1/2 transition-all duration-300 md:left-auto md:right-8 md:top-auto md:bottom-28 md:translate-x-0 md:translate-y-0 ${
          callPopOpen ? "visible opacity-100 scale-100" : "invisible opacity-0 scale-95 pointer-events-none"
        }`}
        role="dialog"
        aria-label="전화 문의"
      >
        <div className="relative rounded-2xl border border-black/10 bg-white p-6 shadow-xl">
          <button
            type="button"
            onClick={() => setCallPopOpen(false)}
            className="absolute right-3 top-3 flex h-8 w-8 items-center justify-center rounded-full text-[#999] hover:bg-black/5 hover:text-[#333]"
            aria-label="닫기"
          >
            <span className="block h-px w-4 rotate-45 bg-current" />
            <span className="absolute block h-px w-4 -rotate-45 bg-current" />
          </button>
          <p className="mb-1 text-sm text-[#666]">오마쥬 의원 전화 문의</p>
          <a href={`tel:${TEL.replace(/-/g, "")}`} className="text-xl font-semibold text-[#1a1918] hover:text-[var(--hip-accent)]">
            {TEL}
          </a>
        </div>
      </div>
      <button
        type="button"
        aria-hidden
        onClick={() => setCallPopOpen(false)}
        className={`fixed inset-0 z-[9999] bg-black/20 transition-opacity duration-300 ${callPopOpen ? "visible opacity-100" : "invisible opacity-0 pointer-events-none"}`}
      />
    </>
  );
}
